{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">Profile</p>
      <h2>{{ rsn }}</h2>
      <p class="lede">Account overview with snapshots, deltas, and activities.</p>
    </div>
    <div class="pill">Total snapshots: {{ total_snapshots }}</div>
  </div>
  <div class="profile-hero" id="profile-hero">
    <div class="stat-block">
      <div class="stat-label">Mode</div>
      {% with mode=mode_value, result={"status": "found"} %}
        {% include "partials/profile_mode_status.html" %}
      {% endwith %}
    </div>
    <div class="stat-block">
      <div class="stat-label">Total Level</div>
      <div class="stat-value"><span id="stat-level">{{ latest.total_level if latest else '—' }}</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-label">Total XP</div>
      <div class="stat-value"><span id="stat-xp">{{ "{:,}".format(latest.total_xp) if latest else '—' }}</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-label">Last snapshot</div>
      <div class="stat-value"><span id="stat-last">{{ latest.fetched_at_display if latest else '—' }}</span></div>
    </div>
    <div class="stat-block">
      <div class="stat-label">Delta</div>
      <div class="stat-value"><span id="stat-delta">{{ latest.delta_summary if latest and latest.delta_summary else '—' }}</span></div>
    </div>
    <form hx-post="/snapshots/run" hx-target="#snapshot-inline" hx-swap="innerHTML" class="snapshot-form">
      <input type="hidden" name="player" value="{{ rsn }}">
      <input type="hidden" name="mode" value="{{ latest.resolved_mode if latest else 'auto' }}">
      <button class="btn primary" type="submit" hx-indicator="#snapshot-indicator">Run snapshot</button>
    </form>
    {% if can_refresh_mode %}
      <form hx-post="/profiles/{{ rsn }}/refresh-mode" hx-target="#mode-status" hx-swap="outerHTML">
        <button class="btn ghost" type="submit">Refresh mode</button>
      </form>
    {% endif %}
    <div id="snapshot-indicator" class="indicator">Running…</div>
  </div>
  <div id="snapshot-inline"></div>
</section>

<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">Timeline</p>
      <h3>Snapshot history</h3>
    </div>
    <div class="form inline">
      <label>Page size
        <select hx-get="/profiles/{{ rsn }}/timeline?page=1" hx-target="#timeline" hx-include="closest .form" name="page_size">
          {% for size in [5,10,20,50] %}
            <option value="{{ size }}" {% if size == 5 %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
  </div>
  <div id="timeline" hx-get="/profiles/{{ rsn }}/timeline" hx-trigger="load" hx-swap="innerHTML"></div>
  <div class="advanced-toggle-row">
    <button class="btn ghost small" id="advanced-toggle" type="button" aria-expanded="false">Show advanced settings</button>
  </div>
  <div class="control-grid advanced-collapsible" id="advanced-controls" data-open="false" style="margin-top:12px;">
    <div class="card control-card">
      <div class="card-header">
        <div>
          <p class="eyebrow">Scheduler</p>
          <h4>Schedule snapshot</h4>
        </div>
      </div>
      <form class="form inline" hx-post="/jobs/schedule/account" hx-target="#job-schedules" hx-swap="innerHTML">
        <label>Account
          <input type="text" name="account_name" value="{{ rsn }}" required>
        </label>
        <label>Frequency
          <select name="cron" required>
            <option value="0 * * * *">Every hour</option>
            <option value="0 */6 * * *" selected>Every 6 hours</option>
            <option value="0 0 * * *">Daily (00:00 UTC)</option>
            <option value="0 6 * * *">Daily (06:00 UTC)</option>
            <option value="0 0 * * 0">Weekly (Sun 00:00 UTC)</option>
            <option value="0 6 * * 1">Weekly (Mon 06:00 UTC)</option>
            <option value="custom">Custom cron…</option>
          </select>
        </label>
        <label>Custom (advanced)
          <input type="text" name="custom_cron" placeholder="*/30 * * * *">
        </label>
        <button class="btn primary small" type="submit">Add schedule</button>
      </form>
    </div>
    <div class="card control-card" id="job-schedules" hx-get="/jobs/schedule/list" hx-trigger="load, every 60s" hx-swap="innerHTML" hx-headers='{"HX-Request":"true"}'></div>
    <div class="card control-card" id="job-status-panel" hx-get="/jobs/status?player={{ rsn }}" hx-trigger="load, every 30s" hx-swap="innerHTML" hx-headers='{"HX-Request":"true"}'></div>
    {% if user %}
      <div class="card control-card">
        <div class="card-header">
          <div>
            <p class="eyebrow">Webhooks</p>
            <h4>User webhooks</h4>
          </div>
        </div>
        <form class="form inline" hx-post="/webhooks/user" hx-target="#webhooks-panel" hx-swap="innerHTML">
          <label>URL
            <input type="url" name="url" placeholder="https://discord.com/api/webhooks/..." required>
          </label>
          <label>Events
            <select name="events">
              <option value="snapshot_complete" selected>snapshot_complete</option>
            </select>
          </label>
          <label>Provider
            <select name="provider">
              <option value="discord" selected>Discord</option>
              <option value="slack">Slack</option>
              <option value="custom">Custom</option>
            </select>
          </label>
          <button class="btn primary small" type="submit">Save webhook</button>
        </form>
        <div id="webhooks-panel" hx-get="/webhooks" hx-trigger="load, every 5m" hx-swap="innerHTML" hx-headers='{"HX-Request":"true"}'></div>
      </div>
    {% endif %}
  </div>
  <div class="form inline" style="margin-top:8px;">
  </div>
  <div class="copy-actions" id="copy-actions" style="display:none;">
    <div class="copy-info">Snapshot content loaded</div>
    <button class="btn ghost small" style="display:none;" id="copy-report-btn">Copy report</button>
    <button class="btn ghost small" style="display:none;" id="copy-json-btn">Copy JSON</button>
  </div>
  <div id="snapshot-content"></div>
  <div id="copy-feedback"></div>
</section>

<div class="snapshot-banner fade-swap" id="snapshot-banner">
  <div class="snapshot-tag" id="snapshot-banner-tag">Viewing snapshot</div>
  {% if latest %}
    <div class="snapshot-meta" id="snapshot-banner-meta">Latest · {{ latest.fetched_at_display }}</div>
    <div class="snapshot-meta" id="snapshot-banner-delta">{{ latest.delta_summary or 'No delta recorded' }}</div>
  {% else %}
    <div class="snapshot-meta" id="snapshot-banner-meta">No snapshot selected</div>
    <div class="snapshot-meta" id="snapshot-banner-delta"></div>
  {% endif %}
</div>

<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">Skills</p>
      <h3>Skill overview</h3>
      <p class="lede">Each card leaves space for icons; add assets later.</p>
    </div>
  </div>
  <div class="skill-grid" id="skills-grid">
    {% if latest and latest.skills %}
      {% set skill_icons = {
        "attack": "Attack_icon.png",
        "strength": "Strength_icon.png",
        "defence": "Defence_icon.png",
        "defense": "Defence_icon.png",
        "ranged": "Ranged_icon.png",
        "prayer": "Prayer_icon.png",
        "magic": "Magic_icon.png",
        "runecraft": "Runecraft_icon.png",
        "runecrafting": "Runecraft_icon.png",
        "construction": "Construction_icon.png",
        "hitpoints": "Hitpoints_icon.png",
        "hitpoint": "Hitpoints_icon.png",
        "agility": "Agility_icon.png",
        "herblore": "Herblore_icon.png",
        "thieving": "Thieving_icon.png",
        "crafting": "Crafting_icon.png",
        "fletching": "Fletching_icon.png",
        "slayer": "Slayer_icon.png",
        "hunter": "Hunter_icon.png",
        "mining": "Mining_icon.png",
        "smithing": "Smithing_icon.png",
        "fishing": "Fishing_icon.png",
        "cooking": "Cooking_icon.png",
        "firemaking": "Firemaking_icon.png",
        "woodcutting": "Woodcutting_icon.png",
        "farming": "Farming_icon.png",
        "sailing": "Sailing_icon.png",
        "combat": "Combat.png",
      } %}
      {% set delta_map = {} %}
      {% if latest.delta and latest.delta.skill_deltas %}
        {% set ns = namespace(map={}) %}
        {% for sd in latest.delta.skill_deltas %}
          {% set _ = ns.map.update({sd.name: sd}) %}
        {% endfor %}
        {% set delta_map = ns.map %}
      {% endif %}
      {% for sk in latest.skills %}
        {% set skill_key = sk.name|lower|replace(' ', '')|replace('_','')|replace('-','') %}
        {% set icon_name = skill_icons.get(skill_key, 'Combat.png') %}
        {% set delta = delta_map.get(sk.name) %}
        {% set xp_delta = delta.xp_delta if delta else 0 %}
        {% set level_delta = delta.level_delta if delta else 0 %}
        <div class="skill-card">
          <div class="skill-icon" style="background-image: url('/static/images/runescape/skills/{{ icon_name }}');"></div>
          <div class="skill-name">{{ sk.name }}</div>
          <div class="skill-value">LVL {{ sk.level }} · XP {{ "{:,}".format(sk.xp) }}</div>
          {% if xp_delta or level_delta %}
            {% set chip_class = 'delta-chip' %}
            {% if xp_delta < 0 %}{% set chip_class = 'delta-chip negative' %}{% elif xp_delta == 0 and level_delta == 0 %}{% set chip_class = 'delta-chip neutral' %}{% endif %}
            <div class="{{ chip_class }}">
              {% if level_delta %}
                {% if level_delta > 0 %}+{% endif %}{{ level_delta }} lvl
              {% endif %}
              {% if xp_delta %}
                {% if xp_delta > 0 %}+{% endif %}{{ "{:,}".format(xp_delta) }} xp
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="ink-2">No skill data yet.</p>
    {% endif %}
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const toggle = document.getElementById("advanced-toggle");
  const panel = document.getElementById("advanced-controls");
  if (!toggle || !panel) return;
  toggle.addEventListener("click", function () {
    const isOpen = panel.getAttribute("data-open") === "true";
    const next = (!isOpen).toString();
    panel.setAttribute("data-open", next);
    toggle.setAttribute("aria-expanded", next);
    toggle.textContent = isOpen ? "Show advanced settings" : "Hide advanced settings";
  });
});
</script>

<script>
(function() {
  function initViz() {
  const tabs = Array.from(document.querySelectorAll('.viz-tab'));
  const panels = Array.from(document.querySelectorAll('.viz-panel'));
  let chartLibLoaded = false;
  let xpChart, kcChart, heatChart;
  let threeLoaded = false;
  let seriesCache = null;
  const rsn = "{{ rsn }}";
  const statusEl = document.getElementById('viz-status');
  let allActivities = [];

  function setStatus(msg) {
    if (!statusEl) return;
    statusEl.textContent = msg || '';
  }

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      if (document.querySelector(`script[src="${src}"]`)) return resolve();
      const s = document.createElement('script');
      s.src = src;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  async function ensureChartLib() {
    if (chartLibLoaded) return;
    await loadScript('/static/js/vendor/chart.umd.min.js');
    await loadScript('/static/js/vendor/chartjs-plugin-zoom.min.js');
    await loadScript('/static/js/vendor/chartjs-chart-matrix.min.js');
    chartLibLoaded = true;
  }

  async function fetchSeries() {
    if (seriesCache) return seriesCache;
    try {
      const resp = await fetch(`/profiles/${rsn}/series`, { credentials: 'same-origin' });
      if (!resp.ok) {
        setStatus('Series fetch failed');
        return { series: [] };
      }
      const ct = resp.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        setStatus('Series response not JSON');
        return { series: [] };
      }
      seriesCache = await resp.json();
      if (seriesCache && seriesCache.series) {
        const names = new Map();
        seriesCache.series.forEach(s => {
          (s.activities || []).forEach(a => {
            const key = (a.name || '').toLowerCase();
            const score = a.score || 0;
            names.set(key, Math.max(names.get(key) || 0, score));
          });
        });
        allActivities = [...names.entries()].sort((a,b)=>b[1]-a[1]).map(([k])=>k);
        window.allActivities = allActivities;
      }
      setStatus('');
      return seriesCache;
    } catch (e) {
      setStatus('Series fetch error');
      return { series: [] };
    }
  }

  function formatTs(ts) {
    try {
      const d = new Date(ts);
      return d.toISOString().replace('T', ' ').slice(0, 16) + ' UTC';
    } catch (e) {
      return ts;
    }
  }

  function parseList(input) {
    return (input || '').split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
  }

  function buildXpChart(series) {
    const ctx = document.getElementById('xp-chart');
    if (!ctx) return;
    const labels = series.map(s => formatTs(s.fetched_at));
    const total = series.map(s => s.total_xp || 0);
    const skillFilter = parseList(document.getElementById('viz-skills').value);
    const skillNames = skillFilter.length ? skillFilter : [];
    const skillDatasets = [];
    if (skillNames.length) {
      skillNames.forEach((name, idx) => {
        const data = series.map(s => {
          const sk = (s.skills || []).find(k => (k.name || '').toLowerCase() === name);
          return sk ? sk.xp : null;
        });
        skillDatasets.push({
          label: name,
          data,
          borderColor: `hsl(${(idx * 60) % 360}, 80%, 60%)`,
          backgroundColor: `hsla(${(idx * 60) % 360}, 80%, 60%, 0.15)`,
          fill: false,
          spanGaps: true,
        });
      });
    }
    const datasets = [
      {
        label: 'Total XP',
        data: total,
        borderColor: '#5be0b1',
        backgroundColor: 'rgba(91,224,177,0.15)',
        fill: true,
        tension: 0.25,
      },
      ...skillDatasets,
    ];
    if (xpChart) xpChart.destroy();
    xpChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true },
          zoom: {
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
            pan: { enabled: true, mode: 'x' }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y?.toLocaleString() || 0} XP`
            }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Snapshot time' }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y: { title: { display: true, text: 'XP' }, grid: { color: 'rgba(255,255,255,0.06)' } }
        }
      }
    });
  }

  function buildKcChart(series) {
    const ctx = document.getElementById('kc-chart');
    if (!ctx) return;
    const bosses = parseList(document.getElementById('viz-kc').value);
    if (!bosses.length) {
      bosses.push(...(allActivities.slice(0, 5).length ? allActivities.slice(0, 5) : ['tempoross']));
      document.getElementById('viz-kc').value = bosses.join(', ');
    }
    const labels = series.map(s => formatTs(s.fetched_at));
    const datasets = bosses.map((boss, idx) => {
      const data = series.map(s => {
        const a = (s.activities || []).find(ac => (ac.name || '').toLowerCase() === boss);
        if (!a) return null;
        if (boss.includes('pvp arena')) {
          return Math.max(a.score || 0, 2500);
        }
        return a.score;
      });
      return {
        label: boss,
        data,
        borderColor: `hsl(${(idx * 70) % 360}, 80%, 65%)`,
        backgroundColor: 'transparent',
        spanGaps: true,
      };
    });
    if (kcChart) kcChart.destroy();
    kcChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true },
          zoom: {
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
            pan: { enabled: true, mode: 'x' }
          },
          tooltip: {
            callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y ?? 0}` }
          }
        },
        scales: {
          x: { title: { display: true, text: 'Snapshot time' }, grid: { color: 'rgba(255,255,255,0.06)' } },
          y: { title: { display: true, text: 'KC / score' }, grid: { color: 'rgba(255,255,255,0.06)' } }
        }
      }
    });
  }

  function buildHeatmap(series) {
    const ctx = document.getElementById('heatmap-canvas');
    if (!ctx) return;
    // Build xp_delta from total_xp differences
    const points = [];
    for (let i = 1; i < series.length; i++) {
      const prev = series[i - 1];
      const cur = series[i];
      const delta = (cur.total_xp || 0) - (prev.total_xp || 0);
      const d = new Date(cur.fetched_at);
      points.push({ dow: d.getUTCDay(), hour: d.getUTCHours(), delta });
    }
    const bucket = {};
    points.forEach(p => {
      const key = `${p.dow}-${p.hour}`;
      bucket[key] = (bucket[key] || 0) + p.delta;
    });
    const data = Object.entries(bucket).map(([key, val]) => {
      const [dow, hour] = key.split('-').map(Number);
      return { x: hour, y: dow, v: val };
    });

    if (heatChart) heatChart.destroy();
    heatChart = new Chart(ctx, {
      type: 'matrix',
      data: {
        datasets: [{
          label: 'XP delta',
          data,
          backgroundColor: ctx => {
            const v = ctx.raw.v || 0;
            if (v > 0) return 'rgba(91,224,177,0.6)';
            if (v < 0) return 'rgba(255,128,128,0.6)';
            return 'rgba(255,255,255,0.05)';
          },
          borderWidth: 1,
          width: () => 18,
          height: () => 18,
        }]
      },
      options: {
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: ctx => {
                const r = ctx[0].raw;
                return `Hour ${r.x}:00 UTC, DOW ${r.y}`;
              },
              label: ctx => `XP Δ: ${ctx.raw.v.toLocaleString()}`
            }
          }
        },
        scales: {
          x: { type: 'linear', min: 0, max: 23, ticks: { stepSize: 4, callback: v => `${v}:00` } },
          y: { type: 'linear', min: 0, max: 6, reverse: true, ticks: { callback: v => ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][v] } }
        }
      }
    });
  }

  async function initCharts() {
    setStatus('Loading series…');
    await ensureChartLib();
    const resp = await fetchSeries();
    const series = resp.series || [];
    if (!series.length) {
      setStatus('No snapshot series available yet');
      return;
    }
    setStatus('');
    buildXpChart(series);
    buildKcChart(series);
    buildHeatmap(series);
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', async () => {
      tabs.forEach(t => t.classList.toggle('active', t === tab));
      const panelId = tab.getAttribute('data-panel');
      panels.forEach(p => p.classList.toggle('active', p.id === panelId));
      if (panelId !== 'orbit-3d') {
        await initCharts();
      } else if (!threeLoaded) {
        threeLoaded = true;
        loadScript('/static/js/vendor/three.module.min.js').catch(() => {});
      }
    });
  });

  const applyXpBtn = document.getElementById('apply-xp');
  if (applyXpBtn) applyXpBtn.addEventListener('click', async () => {
    const resp = await fetchSeries();
    const series = resp.series || [];
    if (!series.length) return;
    buildXpChart(series);
  });

  const applyKcBtn = document.getElementById('apply-kc');
  if (applyKcBtn) applyKcBtn.addEventListener('click', async () => {
    const resp = await fetchSeries();
    const series = resp.series || [];
    if (!series.length) return;
    buildKcChart(series);
  });

  // Load XP chart on page load
  initCharts();
  window.vizRefreshCharts = () => initCharts();
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initViz);
  } else {
    initViz();
  }
})();

// Modal controls for chart settings
(function(){
  let modal, backdrop, openBtn, closeBtn, saveBtn;
  let rangeInput, skillsInput, kcInput, formRange, formSkills, formKc;
  const allSkills = [
    "attack","defence","strength","hitpoints","ranged","prayer","magic","cooking","woodcutting","fletching","fishing",
    "firemaking","crafting","smithing","mining","herblore","agility","thieving","slayer","farming","runecraft","hunter",
    "construction","sailing"
  ];

  function ensureRefs() {
    modal = modal || document.getElementById('viz-modal');
    backdrop = backdrop || document.getElementById('viz-modal-backdrop');
    openBtn = openBtn || document.getElementById('open-viz-settings');
    closeBtn = closeBtn || document.getElementById('viz-modal-cancel');
    saveBtn = saveBtn || document.getElementById('viz-modal-save');
    rangeInput = rangeInput || document.getElementById('viz-range');
    skillsInput = skillsInput || document.getElementById('viz-skills');
    kcInput = kcInput || document.getElementById('viz-kc');
    formRange = formRange || document.getElementById('form-viz-range');
    formSkills = formSkills || document.getElementById('form-viz-skills');
    formKc = formKc || document.getElementById('form-viz-kc');
  }

  function populateChecks() {
    ensureRefs();
    const skillBox = document.getElementById('skill-checks');
    const kcBox = document.getElementById('kc-checks');
    if (skillBox) {
      skillBox.innerHTML = allSkills.map((s, idx) =>
        `<label><input type="checkbox" data-skill value="${s}" ${idx < 4 ? 'checked' : ''}> ${s}</label>`
      ).join('');
    }
    if (kcBox) {
      const topBosses = (window.allActivities || []).slice(0, 30);
      kcBox.innerHTML = topBosses.length
        ? topBosses.map((b, idx) =>
            `<label><input type="checkbox" data-kc value="${b}" ${idx < 8 ? 'checked' : ''}> ${b}</label>`
          ).join('')
        : '<p class="ink-2">Run snapshots to load bosses.</p>';
    }
  }

  function openModal() {
    ensureRefs();
    populateChecks();
    if (!modal || !backdrop) return;
    formRange.value = rangeInput.value || 'all';
    const skills = (skillsInput.value || '').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    document.querySelectorAll('[data-skill]').forEach(cb => {
      cb.checked = skills.length ? skills.includes(cb.value) : cb.checked;
    });
    const kcList = (kcInput.value || '').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
    document.querySelectorAll('[data-kc]').forEach(cb => {
      cb.checked = kcList.length ? kcList.includes(cb.value) : cb.checked;
    });
    backdrop.style.display = 'flex';
  }
  function closeModal() {
    ensureRefs();
    if (!backdrop) return;
    backdrop.style.display = 'none';
  }
  function saveModal() {
    ensureRefs();
    if (!rangeInput || !formRange) return;
    rangeInput.value = formRange.value || 'all';
    const skillsSelected = Array.from(document.querySelectorAll('[data-skill]:checked')).map(cb => cb.value);
    const kcSelected = Array.from(document.querySelectorAll('[data-kc]:checked')).map(cb => cb.value);
    skillsInput.value = skillsSelected.join(', ');
    kcInput.value = kcSelected.join(', ');
    closeModal();
    // retrigger charts
    if (window.vizRefreshCharts) window.vizRefreshCharts();
  }

  function bindModal() {
    ensureRefs();
    populateChecks();
    openBtn?.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
    closeBtn?.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
    saveBtn?.addEventListener('click', (e) => { e.preventDefault(); saveModal(); });
    backdrop?.addEventListener('click', (e) => { if (e.target === backdrop) closeModal(); });
    document.getElementById('skills-all')?.addEventListener('click', () => {
      document.querySelectorAll('[data-skill]').forEach(cb => cb.checked = true);
    });
    document.getElementById('skills-none')?.addEventListener('click', () => {
      document.querySelectorAll('[data-skill]').forEach(cb => cb.checked = false);
    });
    document.getElementById('kc-all')?.addEventListener('click', () => {
      document.querySelectorAll('[data-kc]').forEach(cb => cb.checked = true);
    });
    document.getElementById('kc-none')?.addEventListener('click', () => {
      document.querySelectorAll('[data-kc]').forEach(cb => cb.checked = false);
    });
    window.vizOpenModal = openModal;
    window.vizCloseModal = closeModal;
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bindModal);
  } else {
    bindModal();
  }
})();
</script>

<section class="card">
  <div class="card-header">
    <div>
      <p class="eyebrow">Activities</p>
      <h3>Bosses & Minigames</h3>
    </div>
  </div>
  <div id="activities-table">
    {% if latest and latest.activities %}
      {% set icon_overrides = {
        "deadmanpoints": "minigame_icon_hs_thumb.png",
        "gridpoints": "minigame_icon_hs_thumb.png",
        "leaguepoints": "minigame_icon_hs_thumb.png"
      } %}
      <div class="activity-scroll">
        <div class="activity-grid">
          {% for act in latest.activities %}
            {% set key = act.name|lower|replace(" ", "")|replace("'", "")|replace("-", "")|replace("(", "")|replace(")", "")|replace(":", "") %}
            {% set icon_name = icon_overrides.get(key, "game_icon_" + key + ".png") %}
            <div class="activity-row">
              <div class="activity-icon" style="background-image:url('/static/images/runescape/game/{{ icon_name }}');"></div>
              <div>
                <div class="activity-name">{{ act.name }}</div>
                <div class="activity-rank">Rank {{ act.rank }}</div>
              </div>
              <div class="activity-score">{{ act.score }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      <p class="ink-2">No activities yet.</p>
    {% endif %}
  </div>
</section>

<section class="viz-section fade-swap">
  <div class="card-header" style="padding:0 0 8px 0;">
    <div>
      <p class="eyebrow">Visuals</p>
      <h3>Trends & 3D</h3>
      <p class="lede">Switch snapshots in the timeline; charts will animate with real series data.</p>
    </div>
  </div>
  <div class="viz-tabs" id="viz-tabs">
    <button class="viz-tab active" data-panel="xp-timeline">XP Timeline</button>
    <button class="viz-tab" data-panel="kc-timeline">KC Timeline</button>
    <button class="viz-tab" data-panel="heatmap">XP Heatmap</button>
    <button class="viz-tab" data-panel="orbit-3d">3D Orbit</button>
    <button class="btn ghost small" type="button" id="open-viz-settings" style="margin-left:auto;" onclick="window.vizOpenModal && window.vizOpenModal();">Chart settings</button>
  </div>
  <div id="viz-status" class="ink-2" style="margin-bottom:6px;"></div>
<div class="viz-panels">
    <div class="viz-panel active fade-swap" id="xp-timeline">
      <input type="hidden" id="viz-range" value="all">
      <input type="hidden" id="viz-skills" value="attack,woodcutting,magic">
      <canvas id="xp-chart" class="viz-canvas"></canvas>
    </div>
    <div class="viz-panel fade-swap" id="kc-timeline">
      <input type="hidden" id="viz-kc" value="tempoross">
      <canvas id="kc-chart" class="viz-canvas"></canvas>
    </div>
    <div class="viz-panel fade-swap" id="heatmap">
      <div class="viz-filters">
        <label>Heatmap metric
          <select id="viz-heatmap-metric">
            <option value="xp_delta" selected>XP delta</option>
            <option value="kc_delta">KC delta</option>
          </select>
        </label>
      </div>
      <canvas id="heatmap-canvas" class="viz-canvas"></canvas>
    </div>
    <div class="viz-panel fade-swap" id="orbit-3d">
      <p class="ink-2">3D orbit of snapshots (time vs total XP vs total level). Will load Three.js on demand.</p>
      <div id="orbit-container" class="viz-3d"></div>
    </div>
  </div>
</section>

<div class="viz-modal-backdrop" id="viz-modal-backdrop">
  <div class="viz-modal" id="viz-modal">
    <div>
      <p class="eyebrow">Chart settings</p>
      <h4>XP & KC filters</h4>
    </div>
    <div class="form-grid">
      <label>Time window
        <select id="form-viz-range">
          <option value="all">All snapshots</option>
          <option value="30d">Last 30 days</option>
          <option value="7d">Last 7 days</option>
        </select>
      </label>
      <div style="grid-column: 1 / span 2;">
        <div style="display:flex; justify-content: space-between; align-items:center;">
          <p class="eyebrow" style="margin:0;">Skills</p>
          <div style="display:flex; gap:6px;">
            <button class="btn ghost small" type="button" id="skills-all">Select all</button>
            <button class="btn ghost small" type="button" id="skills-none">None</button>
          </div>
        </div>
        <div class="check-grid" id="skill-checks"></div>
      </div>
      <div style="grid-column: 1 / span 2;">
        <div style="display:flex; justify-content: space-between; align-items:center;">
          <p class="eyebrow" style="margin:0;">Bosses & Minigames</p>
          <div style="display:flex; gap:6px;">
            <button class="btn ghost small" type="button" id="kc-all">Select all</button>
            <button class="btn ghost small" type="button" id="kc-none">None</button>
          </div>
        </div>
        <div class="check-grid" id="kc-checks"></div>
      </div>
    </div>
    <div class="viz-modal-actions">
      <button class="btn ghost small" id="viz-modal-cancel" type="button">Cancel</button>
      <button class="btn primary small" id="viz-modal-save" type="button">Apply</button>
    </div>
  </div>
</div>
{% endblock %}
