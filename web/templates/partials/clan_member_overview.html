{% import "partials/boss_clue_list.html" as bossclue %}
{% set skill_icons = {
  "attack": "Attack_icon.png",
  "strength": "Strength_icon.png",
  "defence": "Defence_icon.png",
  "defense": "Defence_icon.png",
  "ranged": "Ranged_icon.png",
  "prayer": "Prayer_icon.png",
  "magic": "Magic_icon.png",
  "runecraft": "Runecraft_icon.png",
  "runecrafting": "Runecraft_icon.png",
  "construction": "Construction_icon.png",
  "hitpoints": "Hitpoints_icon.png",
  "hitpoint": "Hitpoints_icon.png",
  "agility": "Agility_icon.png",
  "herblore": "Herblore_icon.png",
  "thieving": "Thieving_icon.png",
  "crafting": "Crafting_icon.png",
  "fletching": "Fletching_icon.png",
  "slayer": "Slayer_icon.png",
  "hunter": "Hunter_icon.png",
  "mining": "Mining_icon.png",
  "smithing": "Smithing_icon.png",
  "fishing": "Fishing_icon.png",
  "cooking": "Cooking_icon.png",
  "firemaking": "Firemaking_icon.png",
  "woodcutting": "Woodcutting_icon.png",
  "farming": "Farming_icon.png",
  "sailing": "Sailing_icon.png",
  "combat": "Combat.png",
} %}

{% set latest = latest or None %}
<div class="card control-card">
  <div class="card-header">
    <div>
      <p class="eyebrow">Member overview</p>
      <h3>{{ member_name }}</h3>
      <p class="ink-2">Latest snapshot stats</p>
    </div>
    <div class="list-actions">
      <button class="btn ghost small"
              hx-get="/clans/{{ clan.slug }}/stats"
              hx-target="#clan-stats"
              hx-swap="innerHTML"
              hx-include="#clan-stats-timeframe">Back to clan overview</button>
      <a class="btn primary small" href="/profiles/{{ member_name|urlencode }}">Open profile</a>
    </div>
  </div>
  {% if latest %}
    <div class="stats-grid">
      <div class="stat-block">
        <div class="stat-label">Mode</div>
        <div class="stat-value">{{ latest.resolved_mode or '—' }}</div>
      </div>
      <div class="stat-block">
        <div class="stat-label">Total Level</div>
        <div class="stat-value">{{ "{:,}".format(latest.total_level) if latest.total_level is not none else '—' }}</div>
      </div>
      <div class="stat-block">
        <div class="stat-label">Total XP</div>
        <div class="stat-value">{{ "{:,}".format(latest.total_xp) if latest.total_xp is not none else '—' }}</div>
      </div>
      <div class="stat-block">
        <div class="stat-label">Last snapshot</div>
        <div class="stat-value">{{ latest.fetched_at_display or latest.fetched_at or '—' }}</div>
      </div>
      <div class="stat-block">
        <div class="stat-label">Delta</div>
        <div class="stat-value">{{ latest.delta_summary or 'No delta recorded' }}</div>
      </div>
    </div>

    {% set delta = latest.delta if latest.delta else None %}
    {% set skill_deltas = [] %}
    {% if delta and delta.skill_deltas %}
      {% set skill_deltas = delta.skill_deltas %}
    {% endif %}

    {% set activity_deltas = [] %}
    {% if delta and delta.activity_deltas %}
      {% set activity_deltas = delta.activity_deltas %}
    {% endif %}

    {% set sorted_skills = skill_deltas|selectattr('xp_delta', '>', 0)|list|sort(attribute='xp_delta', reverse=True) %}
    {% set latest_skills = latest.skills or [] %}
    {% if sorted_skills|length == 0 and latest_skills %}
      {% set sorted_skills = latest_skills|sort(attribute='xp', reverse=True) %}
    {% endif %}
    {% set latest_acts = latest.activities or [] %}
    {% set activity_list = activity_deltas|selectattr('score_delta', '>', 0)|list %}
    {% set activity_list = activity_list if activity_list|length > 0 else latest_acts %}
    <div class="card-grid">
      <div class="card control-card">
        <div class="card-header">
          <div>
            <p class="eyebrow">Skill gains</p>
            <h4>Top skills</h4>
          </div>
        </div>
        <div class="list scrollable">
          {% for sd in sorted_skills[:8] %}
            {% set sname = sd.name if sd.name is defined else sd['name'] if sd['name'] is defined else sd %}
            {% set key = sname|lower|replace(' ', '')|replace('_','')|replace('-','') %}
            {% set icon = skill_icons.get(key, 'Combat.png') %}
            {% set xp_val = sd.xp_delta if sd.xp_delta is defined else sd['xp_delta'] if sd['xp_delta'] is defined else sd.xp if sd.xp is defined else sd['xp'] if sd['xp'] is defined else 0 %}
            <div class="list-row skill-row">
              <div class="list-title" style="display:flex; align-items:center; gap:8px;">
                <span class="chip-icon" style="background-image:url('/static/images/runescape/skills/{{ icon }}');"></span>
                <span>{{ sname }}</span>
              </div>
              <div class="list-sub" style="text-align:right;">
                <span class="chip positive small">+{{ "{:,}".format(xp_val|int) }} XP</span>
              </div>
            </div>
          {% endfor %}
          {% if sorted_skills|length == 0 %}
            <p class="ink-2">No skill data yet.</p>
          {% endif %}
        </div>
      </div>
      {% set ns_build = namespace(items=[]) %}
      {% for ad in activity_list %}
        {% set aname = ad.name if ad.name is defined else ad['name'] if ad['name'] is defined else '' %}
        {% set delta = ad.score_delta if ad.score_delta is defined else ad['score_delta'] if ad['score_delta'] is defined else ad.score if ad.score is defined else ad['score'] if ad['score'] is defined else 0 %}
        {% set delta = delta|int %}
        {% if aname and delta > 0 %}
          {% set ns_build.items = ns_build.items + [{'name': aname, 'total': delta, 'top_member': member_name, 'top_value': delta}] %}
        {% endif %}
      {% endfor %}
      {% set ns = namespace(boss_items=[], clue_items=[]) %}
      {% for act in ns_build.items %}
        {% if 'clue' in act.name|lower %}
          {% set ns.clue_items = ns.clue_items + [act] %}
        {% else %}
          {% set ns.boss_items = ns.boss_items + [act] %}
        {% endif %}
      {% endfor %}
      {{ bossclue.render_boss_clue_list(ns.boss_items, "Boss gains", False, False, False) }}
      {{ bossclue.render_boss_clue_list(ns.clue_items, "Clue gains", True, False, False) }}
    </div>
  {% else %}
    <div class="alert warn">No snapshots found for this member yet.</div>
  {% endif %}
</div>
