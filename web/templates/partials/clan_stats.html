{% set skill_icons = {
  "attack": "Attack_icon.png",
  "strength": "Strength_icon.png",
  "defence": "Defence_icon.png",
  "defense": "Defence_icon.png",
  "ranged": "Ranged_icon.png",
  "prayer": "Prayer_icon.png",
  "magic": "Magic_icon.png",
  "runecraft": "Runecraft_icon.png",
  "runecrafting": "Runecraft_icon.png",
  "construction": "Construction_icon.png",
  "hitpoints": "Hitpoints_icon.png",
  "hitpoint": "Hitpoints_icon.png",
  "agility": "Agility_icon.png",
  "herblore": "Herblore_icon.png",
  "thieving": "Thieving_icon.png",
  "crafting": "Crafting_icon.png",
  "fletching": "Fletching_icon.png",
  "slayer": "Slayer_icon.png",
  "hunter": "Hunter_icon.png",
  "mining": "Mining_icon.png",
  "smithing": "Smithing_icon.png",
  "fishing": "Fishing_icon.png",
  "cooking": "Cooking_icon.png",
  "firemaking": "Firemaking_icon.png",
  "woodcutting": "Woodcutting_icon.png",
  "farming": "Farming_icon.png",
  "sailing": "Sailing_icon.png",
  "combat": "Combat.png",
} %}

{% import "partials/boss_clue_list.html" as bossclue %}

{% set totals = data.totals %}
{% set activities = data.activities or {} %}
{% set timeframe_label = data.timeframe|upper %}
<div class="tabs" data-tabs>
  <div class="tab-list">
    <button class="tab-btn active" data-tab-target="#clan-overview">Overview</button>
    <button class="tab-btn" data-tab-target="#clan-leaderboard">Leaderboard</button>
    <button class="tab-btn" data-tab-target="#clan-activities">Activities</button>
  </div>
  <div class="tab-panels">
    <div class="tab-panel active" id="clan-overview">
      <div class="stats-grid">
        <div class="stat-block">
          <div class="stat-label">Total XP</div>
          <div class="stat-value">
            {{ "{:,}".format(totals.xp) if totals.xp is not none else '—' }}
            <span class="chip small positive">+{{ "{:,}".format(totals.xp_gain) }} ({{ timeframe_label }})</span>
          </div>
        </div>
        <div class="stat-block">
          <div class="stat-label">Total Level</div>
          <div class="stat-value">
            {{ "{:,}".format(totals.level) if totals.level is not none else '—' }}
            <span class="chip small muted">+{{ "{:,}".format(totals.level_gain) }} ({{ timeframe_label }})</span>
          </div>
        </div>
        <div class="stat-block">
          <div class="stat-label">Members</div>
          <div class="stat-value">{{ totals.members }}</div>
        </div>
        <div class="stat-block">
          <div class="stat-label">Boss KC gained ({{ timeframe_label }})</div>
          <div class="stat-value"><span class="chip small positive">+{{ activities.bosses or 0 }}</span></div>
        </div>
        <div class="stat-block">
          <div class="stat-label">Clues completed ({{ timeframe_label }})</div>
          <div class="stat-value"><span class="chip small positive">+{{ activities.clues or 0 }}</span></div>
        </div>
      </div>
      <div class="card-grid">
        <div class="card control-card">
          <div class="card-header">
            <div>
              <p class="eyebrow">Skill gains</p>
              <h4>Top skills ({{ timeframe_label }})</h4>
            </div>
          </div>
          <div class="list scrollable">
            {% for sk, xp in data.top_skills[:8] %}
              {% set key = sk|lower|replace(' ', '')|replace('_','')|replace('-','') %}
              {% set icon = skill_icons.get(key, 'Combat.png') %}
              <div class="list-row skill-row">
                <div class="list-title" style="display:flex; align-items:center; gap:8px;">
                  <span class="chip-icon" style="background-image:url('/static/images/runescape/skills/{{ icon }}');"></span>
                  <span>{{ sk }}</span>
                </div>
                <div class="list-sub" style="text-align:right;">
                  <span class="chip positive small">+{{ "{:,}".format(xp|int) }} XP</span>
                </div>
              </div>
            {% endfor %}
            {% if not data.top_skills %}
              <p class="ink-2">No skill gains yet.</p>
            {% endif %}
          </div>
        </div>
        {{ bossclue.render_boss_clue_list(data.top_bosses, "Boss gains", False, True, fallback=False) }}
        {{ bossclue.render_boss_clue_list(data.top_clues, "Clue gains", True, True, fallback=False) }}
      </div>
    </div>
    <div class="tab-panel" id="clan-leaderboard">
      <div id="clan-leaderboard-panel"
           hx-get="/clans/{{ clan.slug }}/leaderboard"
           hx-trigger="load, change from:#clan-stats-timeframe"
           hx-include="#clan-stats-timeframe"
           hx-swap="innerHTML">
      </div>
    </div>
    <div class="tab-panel" id="clan-activities">
      {% set ns = namespace(boss_items=[], clue_items=[]) %}
      {% for act in data.top_activities %}
        {% if act.total > 0 and act.name %}
          {% if 'clue' in act.name|lower %}
            {% set ns.clue_items = ns.clue_items + [act] %}
          {% else %}
            {% set ns.boss_items = ns.boss_items + [act] %}
          {% endif %}
        {% endif %}
      {% endfor %}
      <div class="card-grid">
        {{ bossclue.render_boss_clue_list(ns.boss_items, "Boss gains", False, True, fallback=False) }}
        {{ bossclue.render_boss_clue_list(ns.clue_items, "Clue gains", True, True, fallback=False) }}
      </div>
    </div>
  </div>
</div>
